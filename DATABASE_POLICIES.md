# Политики безопасности базы данных (Row Level Security)

## Обзор

Этот документ описывает все политики Row Level Security (RLS), настроенные в базе данных приложения медицинского обучения. RLS обеспечивает безопасность данных на уровне строк, контролируя доступ пользователей к информации.

## Система ролей

В приложении используется система ролей через отдельную таблицу `user_roles`:

```sql
create type public.app_role as enum ('admin', 'student');
```

### Функция проверки ролей

```sql
create function public.has_role(_user_id uuid, _role app_role)
returns boolean
```

Эта функция используется в политиках для проверки наличия определенной роли у пользователя. Использование `SECURITY DEFINER` предотвращает рекурсивные проблемы с RLS.

---

## Таблица: `profiles`

Хранит профили пользователей с дополнительной информацией.

### Колонки
- `id` (uuid) - ID пользователя, связан с auth.users
- `full_name` (text) - Полное имя
- `email` (text) - Email адрес
- `role` (app_role) - Роль по умолчанию (student)
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Profiles: users can view own**
- **Операция**: SELECT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = id`
- **Описание**: Пользователи могут просматривать только свой собственный профиль

#### 2. **Profiles: admins can view all**
- **Операция**: SELECT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Администраторы могут просматривать все профили

#### 3. **Profiles: users can insert own**
- **Операция**: INSERT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = id`
- **Описание**: Пользователи могут создавать только свой профиль (при регистрации)

#### 4. **Profiles: users can update own**
- **Операция**: UPDATE
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = id`
- **Описание**: Пользователи могут обновлять только свой профиль

### Запрещенные операции
- ❌ DELETE - никто не может удалять профили через API

---

## Таблица: `user_roles`

Управляет ролями пользователей в системе.

### Колонки
- `id` (uuid) - Первичный ключ
- `user_id` (uuid) - ID пользователя
- `role` (app_role) - Роль пользователя

### Политики

#### 1. **Users can view own roles**
- **Операция**: SELECT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи могут видеть свои роли

#### 2. **Admins can manage roles**
- **Операция**: ALL (SELECT, INSERT, UPDATE, DELETE)
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Администраторы имеют полный контроль над ролями пользователей

---

## Таблица: `themes`

Содержит образовательные темы для обучения.

### Колонки
- `id` (integer) - ID темы
- `name` (text) - Название темы
- `description` (text) - Описание
- `content` (text) - Контент темы
- `level`, `format`, `hours`, `order_index` - Метаданные
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Anyone can view themes**
- **Операция**: SELECT
- **Кто**: Все (включая неаутентифицированных)
- **Условие**: `true`
- **Описание**: Темы доступны для просмотра всем пользователям

#### 2. **Admins can insert themes**
- **Операция**: INSERT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут создавать новые темы

#### 3. **Admins can update themes**
- **Операция**: UPDATE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут редактировать темы

#### 4. **Admins can delete themes**
- **Операция**: DELETE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут удалять темы

---

## Таблица: `test_questions`

Хранит вопросы для тестов по темам.

### Колонки
- `id` (integer) - ID вопроса
- `theme_id` (integer) - Связь с темой
- `question` (text) - Текст вопроса
- `option_a`, `option_b`, `option_c`, `option_d` (text) - Варианты ответов
- `correct_answer` (text) - Правильный ответ
- `hint` (text) - Подсказка
- `source` (text) - Источник
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Anyone can view questions**
- **Операция**: SELECT
- **Кто**: Все (включая неаутентифицированных)
- **Условие**: `true`
- **Описание**: Вопросы доступны для просмотра всем

#### 2. **Admins can insert questions**
- **Операция**: INSERT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут создавать вопросы

#### 3. **Admins can update questions**
- **Операция**: UPDATE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут редактировать вопросы

#### 4. **Admins can delete questions**
- **Операция**: DELETE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут удалять вопросы

---

## Таблица: `theme_media`

Связывает медиафайлы с темами.

### Колонки
- `id` (uuid) - ID записи
- `theme_id` (integer) - Связь с темой
- `file_name`, `file_path`, `file_type` (text) - Информация о файле
- `media_type` (text) - Тип медиа
- `file_size` (integer) - Размер файла
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Anyone can view theme media**
- **Операция**: SELECT
- **Кто**: Все (включая неаутентифицированных)
- **Условие**: `true`
- **Описание**: Медиафайлы доступны для просмотра всем

#### 2. **Admins can insert theme media**
- **Операция**: INSERT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут загружать медиафайлы

#### 3. **Admins can update theme media**
- **Операция**: UPDATE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут обновлять информацию о медиафайлах

#### 4. **Admins can delete theme media**
- **Операция**: DELETE
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Только администраторы могут удалять медиафайлы

---

## Таблица: `test_results`

Хранит результаты тестов пользователей.

### Колонки
- `id` (uuid) - ID результата
- `user_id` (uuid) - ID пользователя
- `theme_id` (integer) - ID темы
- `score` (integer) - Набранные баллы
- `total_questions` (integer) - Всего вопросов
- `percentage` (numeric) - Процент правильных ответов
- `passed` (boolean) - Тест пройден
- `time_spent` (integer) - Затраченное время
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Users can view own test results**
- **Операция**: SELECT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи видят только свои результаты

#### 2. **Admins can view all test results**
- **Операция**: SELECT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Администраторы видят результаты всех пользователей

#### 3. **Users can create own test results**
- **Операция**: INSERT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи могут сохранять только свои результаты

### Запрещенные операции
- ❌ UPDATE - никто не может изменять результаты
- ❌ DELETE - никто не может удалять результаты

---

## Таблица: `user_progress`

Отслеживает прогресс пользователя по темам.

### Колонки
- `id` (uuid) - ID записи
- `user_id` (uuid) - ID пользователя
- `theme_id` (integer) - ID темы
- `completed` (boolean) - Тема завершена
- `time_spent` (integer) - Затраченное время
- `completed_at` (timestamp) - Когда завершена
- `created_at`, `updated_at` - Временные метки

### Политики

#### 1. **Users can view own progress**
- **Операция**: SELECT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи видят только свой прогресс

#### 2. **Admins can view all progress**
- **Операция**: SELECT
- **Кто**: Администраторы
- **Условие**: `has_role(auth.uid(), 'admin')`
- **Описание**: Администраторы видят прогресс всех пользователей

#### 3. **Users can create own progress**
- **Операция**: INSERT
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи могут создавать записи своего прогресса

#### 4. **Users can update own progress**
- **Операция**: UPDATE
- **Кто**: Аутентифицированные пользователи
- **Условие**: `auth.uid() = user_id`
- **Описание**: Пользователи могут обновлять свой прогресс

### Запрещенные операции
- ❌ DELETE - никто не может удалять записи прогресса

---

## Storage: bucket `theme-media`

### Политики хранилища

Для работы с файлами в Storage применяются следующие политики:

#### Публичный доступ
- **Просмотр**: Все файлы в bucket доступны для просмотра всем пользователям
- **Загрузка**: Только администраторы могут загружать файлы
- **Обновление**: Только администраторы могут обновлять файлы
- **Удаление**: Только администраторы могут удалять файлы

---

## Схема безопасности

### Уровни доступа

1. **Публичный доступ (неаутентифицированные пользователи)**
   - ✅ Просмотр тем (`themes`)
   - ✅ Просмотр вопросов (`test_questions`)
   - ✅ Просмотр медиафайлов (`theme_media`)
   - ✅ Просмотр файлов в Storage

2. **Студенты (аутентифицированные пользователи)**
   - ✅ Все из публичного доступа
   - ✅ Просмотр своего профиля
   - ✅ Обновление своего профиля
   - ✅ Просмотр своих ролей
   - ✅ Просмотр своих результатов тестов
   - ✅ Сохранение новых результатов тестов
   - ✅ Просмотр своего прогресса
   - ✅ Обновление своего прогресса

3. **Администраторы**
   - ✅ Все из студентов
   - ✅ Просмотр всех профилей
   - ✅ Управление ролями пользователей
   - ✅ Полное управление темами (CRUD)
   - ✅ Полное управление вопросами (CRUD)
   - ✅ Полное управление медиафайлами (CRUD)
   - ✅ Просмотр результатов всех пользователей
   - ✅ Просмотр прогресса всех пользователей
   - ✅ Управление файлами в Storage

---

## Рекомендации по безопасности

### Для разработчиков

1. **Всегда проверяйте аутентификацию**
   ```typescript
   const { data: { user } } = await supabase.auth.getUser();
   if (!user) throw new Error('Not authenticated');
   ```

2. **Используйте `auth.uid()` для привязки данных**
   ```typescript
   await supabase.from('test_results').insert({
     user_id: user.id,  // Всегда явно указывать
     theme_id: themeId,
     score: score
   });
   ```

3. **Не полагайтесь на клиентскую проверку ролей**
   - RLS политики - единственная надежная защита
   - Клиентские проверки только для UX

4. **Тестируйте политики**
   - Проверяйте доступ под разными ролями
   - Используйте `supabase.auth.signInWithPassword()` для тестирования

### Для администраторов

1. **Управление ролями**
   - Назначайте роль 'admin' только доверенным пользователям
   - Роли хранятся в отдельной таблице `user_roles`

2. **Мониторинг**
   - Регулярно проверяйте логи доступа
   - Следите за неудачными попытками доступа

3. **Резервное копирование**
   - Регулярно создавайте бэкапы базы данных
   - Особенно перед изменением политик

---

## Диагностика проблем

### "Не вижу свои данные"
- Проверьте аутентификацию: `auth.uid()` должен вернуть UUID
- Убедитесь, что `user_id` в записях совпадает с `auth.uid()`
- Проверьте наличие роли в таблице `user_roles`

### "Не могу вставить данные"
- Проверьте, что передаете `user_id` явно
- Убедитесь, что `user_id` = `auth.uid()`
- Проверьте, что все обязательные поля заполнены

### "Infinite recursion detected"
- Используйте функцию `has_role()` вместо прямых запросов к таблицам в политиках
- Убедитесь, что функция имеет `SECURITY DEFINER`

---

## Изменение политик

**ВНИМАНИЕ**: Изменение политик RLS может привести к проблемам безопасности или недоступности данных.

### Процесс изменения:

1. **Создайте миграцию**
   ```sql
   -- Удалить старую политику
   DROP POLICY IF EXISTS "old_policy_name" ON table_name;
   
   -- Создать новую политику
   CREATE POLICY "new_policy_name" 
   ON table_name
   FOR SELECT
   USING (condition);
   ```

2. **Протестируйте локально**
   - Проверьте под разными пользователями
   - Убедитесь, что данные доступны

3. **Примените на продакшене**
   - Используйте инструменты миграции
   - Имейте план отката

---

## Дата создания документа
Создано: 2025-01-05

## Версия базы данных
Актуально для текущей схемы базы данных проекта медицинского обучения.
